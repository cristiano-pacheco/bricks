# AGENTS.md

This file provides guidance to LLMs when working with code in this repository.

## Project Overview

**Bricks** (`github.com/cristiano-pacheco/bricks`) is a Go library of reusable, production-ready building blocks for web applications. Every package under `pkg/` is independently importable and designed for first-class **Uber FX** dependency injection integration.

## Commands

```bash
# Run all unit tests
make test                       # CGO_ENABLED=0 go test ./...

# Run a single test or package
go test ./pkg/ucdecorator/...
go test -run TestMyFunc ./pkg/config/...

# Linting
make lint                       # golangci-lint run ./...

# Unit tests with race detector + coverage report (→ reports/cover.html)
make cover

# Integration tests (requires Docker)
make test-integration
make test-integration-race

# Regenerate all mocks
make update-mocks

# Full pipeline
make all                        # install-libs + lint + test + cover

# Static analysis
make static                     # lint + vuln-check + nilaway
```

## Architecture

All packages live under `pkg/`. Each one follows the same structure:
- A `Config` struct with `config:` tags for Koanf unmarshaling
- A `New()` constructor (or `NewWithLifecycle` for FX-integrated ones)
- An exported `var Module = fx.Module(...)` for dependency injection

### Key Packages

| Package | Purpose |
|---|---|
| `pkg/config` | Generic config loading: `config.New[T](path)`, merges `base.yaml` + env YAML + env vars |
| `pkg/logger` | Uber Zap wrapper with `Logger` interface; console (dev) / JSON (prod) |
| `pkg/errs` | Structured `Error{Status, Code, Message, Details}` with HTTP semantics |
| `pkg/database` | GORM/PostgreSQL with pooling, retry on connect, FX lifecycle |
| `pkg/redis` | go-redis universal client with namespace helpers and optional Prometheus metrics |
| `pkg/metrics` | `UseCaseMetrics` interface backed by Prometheus (duration, success, error counters) |
| `pkg/ucdecorator` | **Decorator pattern for use cases** — logging, metrics, tracing, translation via generics |
| `pkg/http/request` | Secure JSON parsing: 1MB limit, unknown field rejection |
| `pkg/http/response` | `JSON[T]()` with `{"data":...}` envelope; `ErrorHandler` mapping errs/validation → HTTP |
| `pkg/http/server/chi` | Chi server with middleware stack, `/healthz`, `/metrics` on separate port, CORS, Swagger |
| `pkg/i18n` | Locale loading and error translation; `ErrorTranslatorService` implements `ucdecorator.ErrorTranslator` |
| `pkg/validator` | go-playground/validator with English translations |
| `pkg/paginator` | `Params{Page, PerPage}`, `ParseQueryParams()`, `Metadata` for responses |
| `pkg/itestkit` | Integration test infrastructure: testcontainers for Postgres + Redis, migration runner, table truncation |
| `pkg/otel/trace` | OpenTelemetry global tracer initialization and `Span()` helper |

### Configuration System

Config is loaded via `config.New[T]("app.nested.path")`:
1. Reads `APP_ENV` env var (default: `local`) → picks `config/{env}.yaml`
2. Loads `config/base.yaml` (required), merges env-specific YAML
3. Overrides from env vars: `APP_*` prefix, `__` as nesting delimiter (e.g., `APP_DATABASE__HOST` → `app.database.host`)

Struct fields use `config:` tags (not `json:`/`yaml:`). FX shortcut: `config.Provide[T]("app.path")`.

### Use Case Decorator Pattern

`pkg/ucdecorator` is the most complex package. Use cases implement:
```go
type UseCase[T any, R any] interface {
    Execute(ctx context.Context, input T) (R, error)
}
```

Two ways to apply decorators:
- **`Chain()`** — explicit manual composition
- **`Factory` + `Wrap()`** — config-driven, auto-names via reflection (struct type → snake_case metric name), optionally wraps each decorator in a `debugDecorator`

### HTTP Route Registration

Routes implement `chi.Route` interface and are collected via FX group tag:
```go
fx.Annotate(NewMyRouter, fx.As(new(chi.Route)), fx.ResultTags(`group:"routes"`))
```

## Testing Conventions

Tests always use `package mypkg_test` (external test package). All mocks are centralized in `test/mocks/` and generated by mockery with `with-expecter: true`.

**Suite pattern** (for structs with injected dependencies):
```go
type MyTestSuite struct {
    suite.Suite
    sut     *mypackage.MyStruct
    mockDep *mocks.MockDependency
}

func (s *MyTestSuite) SetupTest() {
    s.mockDep = mocks.NewMockDependency(s.T())
    s.sut = mypackage.New(s.mockDep)
}

func TestMyStructSuite(t *testing.T) { suite.Run(t, new(MyTestSuite)) }

func (s *MyTestSuite) TestMethod_Scenario_ExpectedResult() {
    // Arrange
    s.mockDep.On("Method", mock.Anything, expected).Return(result, nil)
    // Act
    got, err := s.sut.Method(ctx, input)
    // Assert
    s.Require().NoError(err)
    s.Equal(expected, got)
}
```

**Function pattern** (for pure logic / no deps):
```go
func TestSomeFunc(t *testing.T) {
    t.Run("scenario", func(t *testing.T) {
        require.Equal(t, expected, actual)
    })
}
```

Key rules:
- Always `mock.Anything` for `context.Context` parameters
- Never call `.AssertExpectations(t)` manually — testify handles it
- Error assertions: `s.Require().ErrorIs(err, target)` in suites, `require.ErrorIs(t, err, target)` in functions
- Name: `TestType_Method_Scenario_Expected` or `TestMethod_Scenario_Expected`

### `export_test.go` Pattern

To expose unexported internals for white-box testing without breaking the public API, use an `export_test.go` file in the same package (not `_test`):
```go
// export_test.go  — build tag ensures test-only
package ucdecorator

func NewTestFactory(...) *Factory { ... }
func (f *Factory) InferUseCaseName(h any) string { return f.inferUseCaseName(h) }
```

## Key Conventions

- **`config:` tag** for all config structs (not `json:`/`yaml:`)
- **`var Module = fx.Module(...)`** exported from every injectable package
- **`NewWithLifecycle`** naming for constructors that register FX `OnStart`/`OnStop` hooks
- **`sut`** field name for system-under-test in test suites
- **No global state** — everything injected via FX; the only exception is the OTel global tracer
- **Error wrapping**: `fmt.Errorf("%w: %w", sentinel, underlying)` (Go 1.20+ multi-wrap)
- **Line length**: 120 chars max; **max function length**: 100 lines
